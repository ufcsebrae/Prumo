# Projeto Prumo: Gera√ß√£o de Relat√≥rios de Or√ßamento

[![Python Version](https://img.shields.io/badge/python-3.9%2B-blue.svg)](https://www.python.org/downloads/)

## üéØ Descri√ß√£o

O **Projeto Prumo** √© um pipeline de dados automatizado para a gera√ß√£o de relat√≥rios financeiros que consolidam m√∫ltiplas fontes de dados: valores **executados** do banco de dados, previs√µes manuais via arquivos CSV e o **planejamento** or√ßament√°rio extra√≠do de tabelas SQL.

A aplica√ß√£o gera um e-mail em HTML, formatado profissionalmente e com design responsivo, contendo um sum√°rio executivo (KPIs) e tabelas detalhadas de Receitas, Despesas e o resultado de Super√°vit/D√©ficit.

## üèõÔ∏è Arquitetura

O projeto segue uma arquitetura modular para separa√ß√£o de responsabilidades, facilitando a manuten√ß√£o e a evolu√ß√£o do c√≥digo.

-   **`src/orcamento/core`**: Cont√©m a l√≥gica central da aplica√ß√£o, como a gest√£o de configura√ß√µes (`.env`) e a inicializa√ß√£o do sistema de logs.
-   **`src/orcamento/data_access`**: Respons√°vel por toda a intera√ß√£o com bancos de dados. Cont√©m a l√≥gica de conex√£o e os scripts SQL em arquivos `.sql` dedicados.
-   **`src/orcamento/processing`**: O c√©rebro do sistema. Cont√©m a l√≥gica de neg√≥cio para combinar as diferentes fontes de dados e aplicar as regras de prioridade de previs√£o.
-   **`src/orcamento/reporting`**: Camada de apresenta√ß√£o. Formata os dados para exibi√ß√£o, estiliza as tabelas e renderiza o template de e-mail.
-   **`main.py`**: O ponto de entrada que orquestra todo o fluxo, da extra√ß√£o de dados ao envio do relat√≥rio.

## üß† Fluxo de Dados e L√≥gica de Neg√≥cio

O relat√≥rio final √© constru√≠do com base em uma hierarquia clara de fontes de dados para cada categoria (`Grupo`) e m√™s.

1.  **Valor Executado:** Se existe um valor executado vindo do banco de dados, ele tem **prioridade m√°xima** e √© o √∫nico valor exibido.
2.  **Valor de Previs√£o:** Se n√£o h√° valor executado, o sistema busca um valor de previs√£o seguindo esta ordem de prioridade:
    *   **Prioridade 1: Previs√£o Manual (CSV):** Um valor inserido no arquivo `previsao_despesas.csv` ou `previsao_receitas.csv` sobrescreve qualquer outra previs√£o.
    *   **Prioridade 2: Previs√£o do Sistema (SQL):** Se n√£o h√° previs√£o manual, o sistema utiliza o valor do planejamento or√ßament√°rio vindo das tabelas `FatoAjustadoNacional` e `orcado_receitas_cenario`.
    *   **Prioridade 3: Proje√ß√£o Calculada:** Se existe um valor executado, mas n√£o h√° previs√£o manual, a previs√£o √© calculada como `Planejado do Sistema - Executado`.

## üõ†Ô∏è Pr√©-requisitos

Para que o projeto funcione em uma nova m√°quina, os seguintes componentes s√£o **obrigat√≥rios**:

1.  **Python:** Vers√£o 3.9 ou superior.
2.  **Git:** Para clonar o reposit√≥rio.
3.  **Microsoft Outlook:** O aplicativo Desktop deve estar instalado e configurado, pois o envio de e-mail √© feito atrav√©s dele.
4.  **Drivers Microsoft:**
    *   **ODBC Driver for SQL Server:** Essencial para a conex√£o com o banco de dados SQL. Recomenda-se a vers√£o 17 ou 18. [Link para Download](https://docs.microsoft.com/en-us/sql/connect/odbc/download-odbc-driver-for-sql-server).

## ‚öôÔ∏è Instala√ß√£o e Configura√ß√£o

Siga os passos abaixo para configurar o ambiente de desenvolvimento em uma nova m√°quina.

1.  **Clone o Reposit√≥rio**
    ```bash
    git clone https://github.com/ufcsebrae/Prumo.git
    cd Prumo
    ```

2.  **Crie e Ative o Ambiente Virtual**
    Isso isola as depend√™ncias do projeto. Recomenda-se o uso do PowerShell no Windows.
    ```powershell
    # Crie o ambiente
    python -m venv .venv

    # Ative o ambiente
    .\.venv\Scripts\Activate.ps1
    ```

3.  **Instale as Depend√™ncias**
    As depend√™ncias s√£o gerenciadas pelo `pyproject.toml`. O comando a seguir instala tudo o que √© necess√°rio.
    ```bash
    pip install -e .
    ```

4.  **Configure as Vari√°veis de Ambiente**
    Crie um arquivo chamado `.env` na raiz do projeto. Ele **n√£o** deve ser enviado para o Git. Copie o conte√∫do abaixo e preencha com os dados corretos do seu ambiente.

    ```dotenv
    # .env

    # -- Conex√£o SQL Server (Executado e Planejado) --
    DB_SERVERNAME="spsvsql39"
    DB_DBNAME="FINANCA"
    DB_DRIVER="ODBC Driver 18 for SQL Server"

    # -- Filtros para a Query de Planejamento (PPA) --
    PPA_FILTRO="PPA 2026 - 2026/Jan"
    ANO_FILTRO=2026

    # -- Configura√ß√µes de E-mail --
    MAIL_RECIPIENT="destinatario1@sebraesp.com.br;destinatario2@sebraesp.com.br"
    MAIL_SUBJECT_PREFIX="Pr√©via Or√ßamento"
    ```

## üìÅ Estrutura dos Arquivos de Dados

Na raiz do projeto, deve existir uma pasta `forecast_data`. Ela cont√©m os arquivos CSV que alimentam a l√≥gica de previs√£o.

#### `de_para_planejamento.csv`
Este arquivo √© **crucial** e funciona como uma ponte entre os dados do sistema de planejamento e os grupos de execu√ß√£o.
-   **Formato:** Deve ter 3 colunas, com o seguinte cabe√ßalho: `Natureza_Planejamento,Grupo_Execucao,Tipo_Fluxo`
-   **Exemplo:**
    ```csv
    Natureza_Planejamento,Grupo_Execucao,Tipo_Fluxo
    Servi√ßos Especializados,SERVI√áOS PROFISSIONAIS E CONTRATADOS,Despesa
    Receita de Produtos,OUTRAS RECEITAS OPERACIONAIS,Receita
    ```

#### `previsao_receitas.csv` e `previsao_despesas.csv`
Estes arquivos servem para o *override* manual das previs√µes.
-   **Formato:** Devem ter 3 colunas, com o seguinte cabe√ßalho: `Grupo,Mes,Valor`
-   **Exemplo:**
    ```csv
    Grupo,Mes,Valor
    SERVI√áOS PROFISSIONAIS E CONTRATADOS,fev,5200000
    ```

## ‚ñ∂Ô∏è Como Executar

Com o ambiente virtual ativado (`(.venv)`) e os arquivos `.env` e de dados configurados, execute o script principal a partir da raiz do projeto:

```bash
python -m orcamento.main
```
O script registrar√° todas as etapas do processo no console e, ao final, enviar√° o e-mail com os relat√≥rios.

## üîß Manuten√ß√£o

-   **Alterar Queries:** Edite os arquivos na pasta `src/orcamento/data_access/sql/`.
-   **Ajustar L√≥gica de Neg√≥cio:** Modifique as fun√ß√µes no arquivo `src/orcamento/processing/financial_analysis.py`.
-   **Mudar Layout do E-mail:** Edite o template em `src/orcamento/reporting/templates/email_template.html`.
-   **Mudar Cores:** Altere as vari√°veis no arquivo `src/orcamento/core/config.py` na classe `ColorSettings`.
